#!/bin/sh
#
# mvpmc startup script
#

#
# Connect to the first available NTP server
#
do_ntp() {
    for i in $1 ; do
	/bin/ntpclient -s -h $i
	if [ $? -eq 0 ] ; then
	    /bin/ntpclient -d -l -h $i &
	    exit 0
	fi
    done
    exit 1
}

#
# Mount everything in /etc/fstab
#
/bin/umount -a

mount -t tmpfs -o "size=1M" tmpfs /memory
insmod unionfs
mount -t unionfs -o dirs=/memory=rw:/=ro unionfs /union
cd /union
mkdir live
pivot_root . live

/bin/mount -a -o rw

#
# Configure lo0
# eth0 will be autoconfigured by the kernel
#
/sbin/ifconfig lo 127.0.0.1

#
# Start telnetd
#
/usr/sbin/telnetd

#
# Load kernel modules
#
insmod os_core
insmod av_core _fmt=1
insmod ircombo
insmod gfx
insmod osdfb
insmod ac3_mod
insmod mvpstb_mod.o mvpmod_major=230
#insmod xrmod

#default timezone
TZ=CST+6CDT,M4.1.0/2,M10.5.0/2; export TZ

udhcpc
. /etc/udhcpc.config

if [ "$HNAME" = "" ] ; then
    hostname $IP
fi

#
# connect to the NTP server
#
if [ "$NTP" != "" ] ; then
    do_ntp "$NTP" &
fi

echo "${IP}    ${HNAME}" >> /etc/hosts

#
# create the user theme directory
#
mkdir /tmp/themes

if [ -n "$DONGLE" ] ; then
    tftp -g -l /etc/dongle.config -r ${DONGLE}.config ${SERVER}
    tftp -g -l /tmp/themes/default.xml -r ${DONGLE}.xml ${SERVER}
    . /etc/dongle.config
fi

if [ -z "`pidof mvpmc`" ] ; then
    if [ -z $SERVER ] ; then
        if [ -z $HOST ] ; then
	    mvpmc -s $IP -c $IP -R "ip=discover" --startup setup --emulate ?          
        else
	    mvpmc -s $HOST -c $HOST --vlc $HOST -R "ip=discover" --emulate ?
        fi    
    else        
	mvpmc -s $SERVER -c $SERVER --vlc $SERVER -R "ip=discover" --emulate ?
    fi
fi
cd /
